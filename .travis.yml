language: go
# see https://docs.travis-ci.com/user/reference/overview/#Virtualization-environments
# for the detail
sudo: requried
dist: trusty

before_install:
  - sudo add-apt-repository ppa:duggan/bats --yes
  - sudo apt-get update -qq
  - sudo apt-get install -qq bats iputils-ping
  - go get github.com/golang/dep/...

install:
  - $GOPATH/bin/dep ensure
  - go get -u golang.org/x/lint/golint

before_script:
  - go vet .
  - golint . | xargs -r false

script:
  - go test -v
  - go build
  - bats tests/acceptanceIPv4.bats
  - bats tests/acceptanceIPv6.bats
  - bats tests/acceptanceIPv4v6.bats

before_deploy:
  - go get -u github.com/laher/goxc
  - mkdir -p $TRAVIS_BUILD_DIR/dist
  - goxc -d=$TRAVIS_BUILD_DIR/dist -pv=$TRAVIS_TAG -bc=linux -tasks=clean-destination,xc,archive,rmbin

deploy:
  provider: releases
  api_key:
    secure: "$DEPLOY_SECURE"
  file_glob: true
  file: "$TRAVIS_BUILD_DIR/dist/**/*.gz"
  on:
    tags: true
    all_branches: true
    condition: "$TRAVIS_TAG =~ ^v[0-9].*$"
  skip_cleanup: true
